# Delete all existing rules
-D

# Buffer size
-b 8192

# Failure mode (2 = panic, 1 = printk, 0 = silent)
-f 1

#===============================================================================
# FILE SYSTEM MONITORING
#===============================================================================

# Monitor /etc changes (config tampering)
-w /etc -p wa -k etc_changes

# Monitor binary directories (backdoor installation)
-w /usr/bin -p wa -k bin_changes
-w /usr/sbin -p wa -k sbin_changes
-w /bin -p wa -k bin_changes
-w /sbin -p wa -k sbin_changes
-w /usr/local/bin -p wa -k local_bin_changes

# Monitor library directories (library injection)
-w /lib -p wa -k lib_changes
-w /lib64 -p wa -k lib64_changes
-w /usr/lib -p wa -k usr_lib_changes

#===============================================================================
# PERSISTENCE MECHANISMS
#===============================================================================

# Cron (scheduled backdoors)
-w /etc/crontab -p wa -k cron_changes
-w /etc/cron.d -p wa -k cron_changes
-w /etc/cron.daily -p wa -k cron_changes
-w /etc/cron.hourly -p wa -k cron_changes
-w /etc/cron.weekly -p wa -k cron_changes
-w /etc/cron.monthly -p wa -k cron_changes
-w /var/spool/cron -p wa -k cron_changes

# Systemd (service backdoors)
-w /etc/systemd -p wa -k systemd_changes
-w /lib/systemd -p wa -k systemd_changes
-w /usr/lib/systemd -p wa -k systemd_changes

# Init scripts
-w /etc/init.d -p wa -k init_changes
-w /etc/rc.local -p wa -k rc_local

#===============================================================================
# AUTHENTICATION & AUTHORIZATION
#===============================================================================

# User accounts
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes
-w /etc/group -p wa -k group_changes
-w /etc/gshadow -p wa -k gshadow_changes

# Sudo
-w /etc/sudoers -p wa -k sudoers_changes
-w /etc/sudoers.d -p wa -k sudoers_changes

# PAM
-w /etc/pam.d -p wa -k pam_changes

# SSH
-w /etc/ssh/sshd_config -p wa -k ssh_config
-w /root/.ssh -p wa -k root_ssh_keys
-w /home -p wa -k home_ssh_keys

#===============================================================================
# NETWORK CONFIGURATION
#===============================================================================

# Hosts file
-w /etc/hosts -p wa -k hosts_changes
-w /etc/hosts.allow -p wa -k hosts_allow
-w /etc/hosts.deny -p wa -k hosts_deny

# DNS
-w /etc/resolv.conf -p wa -k dns_changes

# Firewall
-w /etc/ufw -p wa -k firewall_changes
-w /etc/iptables -p wa -k iptables_changes

#===============================================================================
# PROCESS EXECUTION
#===============================================================================

# Track all execve calls (program execution)
-a always,exit -F arch=b64 -S execve -k exec_log
-a always,exit -F arch=b32 -S execve -k exec_log

# Track socket creation (network connections)
-a always,exit -F arch=b64 -S socket -k socket_create
-a always,exit -F arch=b32 -S socket -k socket_create

# Track ptrace (debugging/injection)
-a always,exit -F arch=b64 -S ptrace -k ptrace_call
-a always,exit -F arch=b32 -S ptrace -k ptrace_call

# Track module loading
-w /sbin/insmod -p x -k module_load
-w /sbin/rmmod -p x -k module_unload
-w /sbin/modprobe -p x -k module_probe
-a always,exit -F arch=b64 -S init_module -S finit_module -k module_insertion
-a always,exit -F arch=b32 -S init_module -S finit_module -k module_insertion

#===============================================================================
# SELF-PROTECTION (MONITOR THE MONITORS)
#===============================================================================

# Monitor this monitoring system
-w /opt/server-monitor -p wa -k monitor_changes

# Monitor audit configuration
-w /etc/audit -p wa -k audit_changes
-w /etc/audit/rules.d -p wa -k audit_rules_changes
-w /etc/audit/auditd.conf -p wa -k audit_conf_changes

# Monitor auditing binaries
-w /sbin/auditctl -p x -k audit_tools
-w /sbin/auditd -p x -k audit_tools

#===============================================================================
# LOCK RULES (IMMUTABLE MODE)
#===============================================================================
# Setting -e 2 makes audit rules immutable until reboot
# This prevents attackers from disabling auditing
-e 2
